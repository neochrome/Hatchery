(function(f){function g(a){if(a.indexOf("//localhost")==0)return a.substring(11);var b=a.indexOf(":");return b>0?a.substring(b-1):a}if(!f.twFile)f.twFile={};f.extend(f.twFile,{currentDriver:null,driverList:["activeX","mozilla","tiddlySaver","javaLiveConnect"],load:function(a){var b=this.getDriver();return b?b.loadFile(a):null},save:function(a,b){var c=this.getDriver();return c?c.saveFile(a,b):null},copy:function(a,b){var c=this.getDriver();return c&&c.copyFile?c.copyFile(a,b):null},convertUriToLocalPath:function(a){a=
a.split("#")[0].split("?")[0];a.indexOf("file://localhost/")==0&&(a="file://"+a.substr(16));var b;a.charAt(9)==":"?b=unescape(a.substr(8)).replace(RegExp("/","g"),"\\"):a.indexOf("file://///")==0?b="\\\\"+unescape(a.substr(10)).replace(RegExp("/","g"),"\\"):a.indexOf("file:///")==0?b=unescape(a.substr(7)):a.indexOf("file:/")==0?b=unescape(a.substr(5)):a.indexOf("//")==0&&(b="\\\\"+unescape(a.substr(7)).replace(RegExp("/","g"),"\\"));return b||a},getDriver:function(){if(this.currentDriver===null)for(var a=
0;a<this.driverList.length;a++)if(this.currentDriver===null&&e[this.driverList[a]].isAvailable&&e[this.driverList[a]].isAvailable())this.currentDriver=e[this.driverList[a]];return this.currentDriver}});f(function(){for(var a in e)e[a].deferredInit&&e[a].deferredInit()});var e={};e.activeX={name:"activeX",isAvailable:function(){try{new ActiveXObject("Scripting.FileSystemObject")}catch(a){return!1}return!0},loadFile:function(a){try{var b=(new ActiveXObject("Scripting.FileSystemObject")).OpenTextFile(a,
1),c=b.ReadAll();b.Close()}catch(d){return null}return c},createPath:function(a){var b=a.lastIndexOf("\\");b!=-1&&(a=a.substring(0,b+1));b=[a];try{for(var c=new ActiveXObject("Scripting.FileSystemObject"),d=c.GetParentFolderName(a);d&&!c.FolderExists(d);)b.push(d),d=c.GetParentFolderName(d);for(i=b.length-1;i>=0;i--)c.FolderExists(b[i])||c.CreateFolder(b[i]);return!0}catch(e){}return!1},copyFile:function(a,b){e.activeX.createPath(a);try{(new ActiveXObject("Scripting.FileSystemObject")).GetFile(b).Copy(a)}catch(c){return!1}return!0},
saveFile:function(a,b){e.activeX.createPath(a);try{var c=(new ActiveXObject("Scripting.FileSystemObject")).OpenTextFile(a,2,-1,0);c.Write(b);c.Close()}catch(d){return null}return!0}};e.mozilla={name:"mozilla",isAvailable:function(){return!!window.Components},loadFile:function(a){if(window.Components)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");var b=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);b.initWithPath(a);
if(!b.exists())return null;var c=Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);c.init(b,1,4,null);var d=Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);d.init(c);var e=d.read(d.available());d.close();c.close();return e}catch(f){return!1}return null},saveFile:function(a,b){if(window.Components)try{netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
var c=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);c.initWithPath(a);c.exists()||c.create(0,436);var d=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);d.init(c,34,4,null);d.write(b,b.length);d.flush();d.close();return!0}catch(e){return alert("Exception while attempting to save\n\n"+e),!1}return null}};e.tiddlySaver={name:"tiddlySaver",deferredInit:function(){!document.applets.TiddlySaver&&
!f.browser.mozilla&&!f.browser.msie&&document.location.toString().substr(0,5)=="file:"&&f(document.body).append("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1'height='1'></applet>")},isAvailable:function(){return!!document.applets.TiddlySaver},loadFile:function(a){var b;try{if(document.applets.TiddlySaver)return b=document.applets.TiddlySaver.loadFile(g(a),"UTF-8"),b===void 0||b===null?null:String(b)}catch(c){}return null},
saveFile:function(a,b){try{if(document.applets.TiddlySaver)return document.applets.TiddlySaver.saveFile(g(a),"UTF-8",b)}catch(c){}return null}};e.javaLiveConnect={name:"javaLiveConnect",isAvailable:function(){return!!window.java&&!!window.java.io&&!!window.java.io.FileReader},loadFile:function(a){var b,c=[];try{b=new java.io.BufferedReader(new java.io.FileReader(g(a)));for(var d;(d=b.readLine())!=null;)c.push(new String(d));b.close()}catch(e){return null}return c.join("\n")+"\n"},saveFile:function(a,
b){try{var c=new java.io.PrintStream(new java.io.FileOutputStream(g(a)));c.print(b);c.close()}catch(d){return null}return!0}}})(jQuery);